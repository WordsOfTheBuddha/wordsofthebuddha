---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import PostCard from "../components/PostCard.astro";
import { routes } from "../utils/routes";
import { getEntry } from "astro:content";
import SaveSolid from "../assets/save-solid.svg?raw";

// Get bookmarked items from cookie
const saves = Astro.cookies.get("wotb_saves")?.json() || {};
const savedSlugs = Object.keys(saves).filter((key) => saves[key]);

// Get entries that exist in routes
const validSlugs = savedSlugs.filter((slug) => routes.includes(slug));

// Fetch all valid entries
const entries = await Promise.all(
	validSlugs.map(async (slug) => {
		try {
			return await getEntry("all", slug);
		} catch {
			return null;
		}
	})
);

// Filter out nulls and sort
const validEntries = entries.filter(Boolean);
const sortedEntries = validEntries.sort((a, b) =>
	a.id.localeCompare(b.id, undefined, { numeric: true })
);
---

<Layout title="Saves" titleIcon={SaveSolid}>
	<div class="posts-grid">
		{
			sortedEntries.length === 0 ? (
				<div class="text-center py-8 text-gray-500">
					<p>No items saved yet.</p>
				</div>
			) : (
				sortedEntries.map((entry) => (
					<PostCard
						id={entry.data.slug}
						title={entry.data.title}
						description={entry.data.description}
						lastUpdated={entry.data.lastUpdated}
					/>
				))
			)
		}
	</div>
</Layout>
