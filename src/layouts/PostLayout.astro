---
import Analytics from "@vercel/analytics/astro";
import SpeedInsights from "@vercel/speed-insights/astro";
import "../styles/global.css";
import "../styles/content.css";
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import BottomDrawer from "../components/BottomDrawer.astro";
import ScrollToTop from "../components/ScrollToTop.astro";
import DiscourseImage from "../components/DiscourseImage.astro";
import Commentary from "../components/Commentary.astro";
import { findContentImage } from "../utils/contentImage";

const props = Astro.props.frontmatter || Astro.props;
const {
	title,
	description,
	date,
	image,
	imageCaption,
	hideHeader = false,
	commentary,
	draft = false,
} = props;

// When hideHeader is true, the layout skips rendering title/description/image
// in the page body — the MDX content handles its own header.
// Frontmatter title/description are still used for SEO meta tags.
const showHeader = !hideHeader;

// If a date string is provided in frontmatter, use it directly for display
// (allows human-readable dates like "June 2025" without date parsing).
const topDate = typeof date === "string" ? date : null;

// --- Date handling ---
// Use frontmatter date if provided, otherwise fall back to file modification time
let displayDate: string | null = null;
if (date) {
	displayDate = new Date(date).toLocaleDateString("en-US", {
		year: "numeric",
		month: "long",
		day: "numeric",
	});
} else {
	// Auto-detect from file system modification time
	try {
		const fs = await import("node:fs");
		const path = await import("node:path");
		// Astro.props.file holds the absolute path for .md pages
		const filePath = (Astro.props as any).file;
		if (filePath) {
			const stat = fs.statSync(filePath);
			displayDate = stat.mtime.toLocaleDateString("en-US", {
				year: "numeric",
				month: "long",
				day: "numeric",
			});
		}
	} catch {
		// Silently ignore — no date shown
	}
}

// --- Banner image handling ---
// Derive slug from the page URL — use last path segment to handle rewrites
// e.g., /toe -> toe, /posts/toe -> toe
const pathSegments = Astro.url.pathname
	.replace(/^\//, "")
	.replace(/\/$/, "")
	.split("/");
const slug = pathSegments[pathSegments.length - 1] || "";
const contentImage = findContentImage(slug, { image, imageCaption }, title);

// Strip annotation markup (|word::tooltip|) from title for SEO
const cleanTitle = title?.replace(/\|([^:|]+)::[^|]*\|/g, "$1");

let SEOTitle = "Words of the Buddha";
if (cleanTitle) {
	SEOTitle = cleanTitle + " - Words of the Buddha";
}

const serverTheme = "dark";
---

<html lang="en" class={serverTheme} dir="ltr">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, viewport-fit=cover"
		/>

		<!-- Preload critical fonts -->
		<link
			rel="preload"
			href="/assets/fonts/Spectral-Regular.woff2"
			as="font"
			type="font/woff2"
			crossorigin
		/>
		<link
			rel="preload"
			href="/assets/fonts/Spectral-Italic.woff2"
			as="font"
			type="font/woff2"
			crossorigin
		/>
		<link
			rel="preload"
			href="/assets/fonts/GentiumPlus-Regular.ttf"
			as="font"
			type="font/ttf"
			crossorigin="anonymous"
		/>

		<title>{SEOTitle}</title>
		<meta
			name="description"
			content={description || "Words of the Buddha"}
		/>

		<!-- Open Graph -->
		<meta property="og:title" content={SEOTitle} />
		<meta
			property="og:description"
			content={description || "Words of the Buddha"}
		/>
		<meta property="og:type" content="article" />
		{
			contentImage && (
				<meta
					property="og:image"
					content={new URL(contentImage.image.src, Astro.url).href}
				/>
			)
		}

		<!-- Twitter Card -->
		<meta
			name="twitter:card"
			content={contentImage ? "summary_large_image" : "summary"}
		/>
		<meta name="twitter:title" content={SEOTitle} />
		<meta
			name="twitter:description"
			content={description || "Words of the Buddha"}
		/>
		{
			contentImage && (
				<meta
					name="twitter:image"
					content={new URL(contentImage.image.src, Astro.url).href}
				/>
			)
		}

		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<link rel="manifest" href="/manifest.webmanifest" />
		<meta name="theme-color" content="#111827" />

		<script is:inline>
			(function () {
				var stored = localStorage.getItem("theme");
				var param = new URLSearchParams(window.location.search).get(
					"theme",
				);
				var theme =
					param === "light" || param === "dark"
						? param
						: stored === "light" || stored === "dark"
							? stored
							: window.matchMedia("(prefers-color-scheme: dark)")
										.matches
								? "dark"
								: "light";
				document.documentElement.classList.remove("light", "dark");
				document.documentElement.classList.add(theme);
				localStorage.setItem("theme", theme);
			})();
		</script>
	</head>
	<body
		class="flex flex-col min-h-screen bg-[var(--background-color)] text-[var(--text-color)] [overflow-x:clip]"
	>
		<Analytics />
		<SpeedInsights />
		<BottomDrawer />
		<main class="flex-1">
			<div class="post-container">
				<div class="post-nav prose prose-lg dark:prose-invert">
					<Navbar showAuth={true} showSearch={true} />
				</div>
				<div class="post-body">
					<article
						class="post-content prose prose-lg dark:prose-invert max-w-none p-4 pt-6"
						style="opacity: 0; transition: opacity 0.15s ease-in;"
					>
						{
							(draft || topDate) && (
								<div class="not-prose post-badge sm:float-right flex items-center gap-2 text-sm sm:ml-4 mb-2 sm:mb-0">
									{draft && (
										<span class="inline-block px-2 py-0.5 rounded bg-amber-100 dark:bg-amber-900/40 text-amber-800 dark:text-amber-300 font-medium text-xs uppercase tracking-wide">
											Draft
										</span>
									)}
									{topDate && (
										<span class="text-gray-500 dark:text-gray-400">
											Edited {topDate}
										</span>
									)}
								</div>
							)
						}
						{
							showHeader && title && (
								<h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 pl-0 mb-2">
									{title}
								</h1>
							)
						}
						{
							showHeader && description && (
								<p class="text-base italic text-[var(--text-muted)] mt-1 mb-4">
									{description}
								</p>
							)
						}
						{
							showHeader && contentImage && (
								<div class="not-prose m-0 mt-4 mb-6 w-full">
									<DiscourseImage imageData={contentImage} />
								</div>
							)
						}
						<slot />
						<Commentary commentary={commentary} />
						{
							displayDate && (
								<div class="mt-12 pt-4 border-t border-gray-200 dark:border-gray-700">
									<p class="text-sm text-gray-500 dark:text-gray-400 m-0">
										Last updated on {displayDate}
									</p>
								</div>
							)
						}
					</article>
					<nav
						class="post-toc"
						id="post-toc"
						aria-label="Table of contents"
					>
					</nav>
				</div>
				<Footer />
			</div>
		</main>
		<ScrollToTop />

		<!-- Mobile ToC: floating button + bottom sheet -->
		<button
			id="mobile-toc-toggle"
			aria-label="Table of contents"
			class="mobile-toc-toggle fixed bottom-4 left-4 p-2.5 rounded-full z-50 opacity-0 invisible transition-all duration-300"
		>
			<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				<line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="15" y2="12"/><line x1="3" y1="18" x2="10" y2="18"/>
			</svg>
		</button>
		<div id="mobile-toc-overlay" class="mobile-toc-overlay">
			<div class="mobile-toc-sheet" id="mobile-toc-sheet">
				<div class="mobile-toc-header">
					<span class="mobile-toc-title">Contents</span>
					<button id="mobile-toc-close" aria-label="Close table of contents" class="mobile-toc-close">
						<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
					</button>
				</div>
				<nav id="mobile-toc-nav" class="mobile-toc-nav" aria-label="Table of contents (mobile)"></nav>
			</div>
		</div>
	</body>

	<style>
		/* Centered container — matches content width on mobile, widens for ToC on desktop */
		.post-container {
			max-width: 56rem;
			margin: 0 auto;
			padding: 0 1rem;
		}

		/* Navbar wrapper — prose gives link colors matching the rest of the site */
		.post-nav {
			max-width: none;
		}

		.post-toc {
			display: none;
		}

		@media (min-width: 1024px) {
			.post-container {
				max-width: calc(56rem + 260px + 1.5rem);
				padding: 0 2rem;
			}
			.post-body {
				display: grid;
				grid-template-columns: minmax(0, 56rem) 260px;
				column-gap: 1.5rem;
			}
			.post-content {
				grid-column: 1;
				min-width: 0;
			}
			.post-toc {
				display: block;
				grid-column: 2;
				position: sticky;
				top: 2rem;
				align-self: start;
				margin-top: 1.5rem;
				max-height: calc(100vh - 4rem);
				overflow-y: auto;
				font-size: 0.82rem;
				line-height: 1.6;
				border-left: 2px solid rgba(245, 158, 11, 0.2);
				padding-left: 0.75rem;
				padding-right: 0.5rem;
			}
			.post-toc :global(a) {
				display: block;
				color: #a8a29e;
				text-decoration: none;
				padding: 0.15rem 0;
				transition: color 0.15s;
			}
			.post-toc :global(a:hover),
			.post-toc :global(a.active) {
				color: #f59e0b;
			}
			.post-toc :global(a.toc-h3) {
				padding-left: 0.75rem;
				font-size: 0.78rem;
			}
		}

		@media (min-width: 1280px) {
			.post-container {
				max-width: calc(56rem + 280px + 2.5rem);
			}
			.post-body {
				grid-template-columns: minmax(0, 56rem) 280px;
				column-gap: 2.5rem;
			}
		}

		/* ── Mobile ToC ── */
		.mobile-toc-toggle {
			background: var(--background-color);
			border: 1px solid var(--surface-border);
			color: var(--primary-color);
			cursor: pointer;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
		}
		.mobile-toc-toggle:active {
			transform: scale(0.95);
		}

		/* Hide on desktop — the sidebar ToC is visible there */
		@media (min-width: 1024px) {
			.mobile-toc-toggle {
				display: none !important;
			}
			.mobile-toc-overlay {
				display: none !important;
			}
		}

		.mobile-toc-overlay {
			position: fixed;
			inset: 0;
			z-index: 60;
			background: rgba(0, 0, 0, 0.45);
			opacity: 0;
			visibility: hidden;
			transition: opacity 0.2s ease, visibility 0.2s ease;
		}
		.mobile-toc-overlay.open {
			opacity: 1;
			visibility: visible;
		}

		.mobile-toc-sheet {
			position: absolute;
			bottom: 0;
			left: 0;
			right: 0;
			max-height: 65vh;
			background: var(--surface-elevated, var(--background-color));
			border-top: 1px solid var(--surface-border);
			border-radius: 1rem 1rem 0 0;
			display: flex;
			flex-direction: column;
			transform: translateY(100%);
			transition: transform 0.25s ease;
		}
		.mobile-toc-overlay.open .mobile-toc-sheet {
			transform: translateY(0);
		}

		.mobile-toc-header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0.875rem 1.25rem 0.625rem;
			border-bottom: 1px solid var(--surface-border);
			flex-shrink: 0;
		}
		.mobile-toc-title {
			font-size: 0.9rem;
			font-weight: 600;
			color: var(--text-color);
		}
		.mobile-toc-close {
			background: none;
			border: none;
			cursor: pointer;
			padding: 0.25rem;
			color: var(--text-muted);
		}

		.mobile-toc-nav {
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
			padding: 0.75rem 1.25rem 1.5rem;
			flex: 1;
		}
		.mobile-toc-nav :global(a) {
			display: block;
			color: #a8a29e;
			text-decoration: none;
			padding: 0.4rem 0;
			font-size: 0.85rem;
			line-height: 1.5;
			transition: color 0.15s;
		}
		.mobile-toc-nav :global(a:active),
		.mobile-toc-nav :global(a.active) {
			color: #f59e0b;
		}
		.mobile-toc-nav :global(a.toc-h3) {
			padding-left: 1rem;
			font-size: 0.8rem;
		}
	</style>

	<script>
		document.addEventListener("DOMContentLoaded", function () {
			// Open all content links in new tabs (skip anchor links)
			var links = document.querySelectorAll(".post-content a");
			for (var i = 0; i < links.length; i++) {
				var href = links[i].getAttribute("href");
				if (href && href.charAt(0) !== "#") {
					links[i].setAttribute("target", "_blank");
					links[i].setAttribute("rel", "noopener");
				}
			}

			// Reveal content after tooltips have been processed by BottomDrawer
			var article = document.querySelector(
				".post-content",
			) as HTMLElement;
			if (article) {
				// Use requestAnimationFrame to ensure BottomDrawer's DOMContentLoaded
				// handler (replaceTooltips) has completed first
				requestAnimationFrame(function () {
					article.style.opacity = "1";
				});
			}

			// Build ToC from headings
			var headings = document.querySelectorAll(
				".post-content h2, .post-content h3",
			);
			var nav = document.getElementById("post-toc");
			if (!nav || headings.length === 0) return;

			for (var j = 0; j < headings.length; j++) {
				var h = headings[j] as HTMLElement;
				if (!h.id) {
					h.id = (h.textContent || "")
						.toLowerCase()
						.replace(/[^a-z0-9]+/g, "-")
						.replace(/(^-|-$)/g, "");
				}
				var a = document.createElement("a");
				a.href = "#" + h.id;
				a.textContent = h.textContent;
				if (h.tagName === "H3") a.className = "toc-h3";
				nav.appendChild(a);
			}

			// ── Mobile ToC ──
			var mobileNav = document.getElementById("mobile-toc-nav");
			var mobileToggle = document.getElementById("mobile-toc-toggle");
			var mobileOverlay = document.getElementById("mobile-toc-overlay");
			var mobileClose = document.getElementById("mobile-toc-close");

			if (mobileNav && mobileToggle && mobileOverlay) {
				// Clone ToC links into mobile nav
				for (var p = 0; p < headings.length; p++) {
					var mh = headings[p] as HTMLElement;
					var ma = document.createElement("a");
					ma.href = "#" + mh.id;
					ma.textContent = mh.textContent;
					if (mh.tagName === "H3") ma.className = "toc-h3";
					mobileNav.appendChild(ma);
				}

				// Show the toggle button (only on mobile, only if headings exist)
				mobileToggle.classList.remove("opacity-0", "invisible");
				mobileToggle.classList.add("opacity-100", "visible");

				function openMobileToc() {
					mobileOverlay!.classList.add("open");
					document.body.style.overflow = "hidden";
				}
				function closeMobileToc() {
					mobileOverlay!.classList.remove("open");
					document.body.style.overflow = "";
				}

				mobileToggle.addEventListener("click", openMobileToc);
				if (mobileClose) mobileClose.addEventListener("click", closeMobileToc);
				mobileOverlay.addEventListener("click", function (e) {
					if (e.target === mobileOverlay) closeMobileToc();
				});

				// Close on link click and scroll to heading
				mobileNav.addEventListener("click", function (e) {
					var target = (e.target as HTMLElement).closest("a");
					if (target) {
						closeMobileToc();
					}
				});
			}

			// Highlight current section on scroll (desktop + mobile ToC)
			var observer = new IntersectionObserver(
				function (entries) {
					for (var k = 0; k < entries.length; k++) {
						if (entries[k].isIntersecting) {
							var headingId = (entries[k].target as HTMLElement).id;
							var selector = 'a[href="#' + headingId + '"]';

							// Desktop ToC
							var tocLinks = nav!.querySelectorAll("a");
							for (var m = 0; m < tocLinks.length; m++)
								tocLinks[m].classList.remove("active");
							var active = nav!.querySelector(selector);
							if (active) active.classList.add("active");

							// Mobile ToC
							if (mobileNav) {
								var mobileTocLinks = mobileNav.querySelectorAll("a");
								for (var q = 0; q < mobileTocLinks.length; q++)
									mobileTocLinks[q].classList.remove("active");
								var mobileActive = mobileNav.querySelector(selector);
								if (mobileActive) mobileActive.classList.add("active");
							}
						}
					}
				},
				{ rootMargin: "-20% 0px -70% 0px" },
			);

			for (var n = 0; n < headings.length; n++)
				observer.observe(headings[n]);
		});
	</script>
</html>
