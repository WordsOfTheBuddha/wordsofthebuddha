---
/**
 * CollectionExportButton.astro
 *
 * Renders a "Download as PDF" button for a collection or sub-collection page.
 * On click it requests /api/export/<slug> and triggers a browser download.
 *
 * Props:
 *   collectionSlug  – the collection identifier (e.g. "snp2", "sn1-11", "dhp")
 *   label           – optional override for the button label
 */

interface Props {
	collectionSlug: string;
	label?: string;
}

const { collectionSlug, label = "Print PDF" } = Astro.props;
import { transformId } from "../utils/transformId";
---

<div class="export-wrapper" data-export-slug={collectionSlug}>
	<button
		type="button"
		class="export-btn"
		aria-label={`Download ${label} for ${transformId(collectionSlug)}`}
		title={`Get a PDF version of ${transformId(collectionSlug)}`}
	>
		<!-- Document icon -->
		<svg
			class="export-icon"
			viewBox="0 0 24 24"
			fill="none"
			stroke="currentColor"
			stroke-width="1.5"
			stroke-linecap="round"
			stroke-linejoin="round"
			aria-hidden="true"
			xmlns="http://www.w3.org/2000/svg"
		>
			<path
				d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z"
			></path>
		</svg>
		<span class="export-label">{label}</span>
		<!-- Spinner (hidden by default) -->
		<svg
			class="export-spinner"
			viewBox="0 0 24 24"
			fill="none"
			aria-hidden="true"
			xmlns="http://www.w3.org/2000/svg"
		>
			<circle
				class="spinner-track"
				cx="12"
				cy="12"
				r="10"
				stroke="currentColor"
				stroke-width="3"></circle>
			<path
				class="spinner-arc"
				d="M12 2a10 10 0 0110 10"
				stroke="currentColor"
				stroke-width="3"
				stroke-linecap="round"></path>
		</svg>
	</button>
	<p class="export-status" aria-live="polite"></p>
</div>

<!-- Error toast (hidden by default, shown via JS) -->
<div class="export-toast" role="alert" aria-live="assertive">
	<span class="toast-msg"></span>
	<button class="toast-close" aria-label="Dismiss">&times;</button>
</div>

<style>
	.export-wrapper {
		display: inline-flex;
		flex-direction: column;
		align-items: flex-start;
		gap: 0.25rem;
		position: relative; /* so status can be absolutely positioned */
	}

	.export-btn {
		display: inline-flex;
		align-items: center;
		gap: 0.35em;
		padding: 0.3rem 0.75rem;
		font-size: 0.8rem;
		font-family: inherit;
		color: var(--text-muted, #666);
		background: transparent;
		border: 1px solid var(--border-color, rgba(44, 44, 44, 0.2));
		border-radius: 9999px;
		cursor: pointer;
		transition:
			color 0.15s,
			border-color 0.15s,
			background 0.15s;
		white-space: nowrap;
	}

	.export-btn:hover:not(:disabled) {
		color: var(--primary-color, #6b21a8);
		border-color: var(--primary-color, #6b21a8);
		background: var(--surface-paper, #faf9f6);
	}

	.export-btn:disabled {
		opacity: 0.6;
		cursor: not-allowed;
	}

	.export-icon {
		width: 1em;
		height: 1em;
		flex-shrink: 0;
	}

	/* Spinner — hidden until .is-loading state */
	.export-spinner {
		display: none;
		width: 1em;
		height: 1em;
		flex-shrink: 0;
		animation: spin 0.9s linear infinite;
	}
	.export-btn.is-loading .export-icon {
		display: none;
	}
	.export-btn.is-loading .export-spinner {
		display: block;
	}
	.export-btn.is-loading .export-label {
		/* Keep label visible while loading so button doesn't shrink */
	}

	@keyframes spin {
		from {
			transform: rotate(0deg);
		}
		to {
			transform: rotate(360deg);
		}
	}

	.spinner-track {
		opacity: 0.25;
	}

	.export-status {
		display: none; /* hidden — errors now use the toast */
	}

	/* ── Error toast ─────────────────────────────────── */
	.export-toast {
		position: fixed;
		bottom: 1.5rem;
		left: 50%;
		transform: translateX(-50%) translateY(calc(100% + 2rem));
		max-width: min(90vw, 480px);
		padding: 0.7rem 1rem;
		background: #c0392b;
		color: #fff;
		font-size: 0.82rem;
		line-height: 1.4;
		border-radius: 8px;
		box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
		display: flex;
		align-items: center;
		gap: 0.6rem;
		z-index: 9999;
		transition: transform 0.3s ease;
		pointer-events: none;
		opacity: 0;
	}
	.export-toast.visible {
		transform: translateX(-50%) translateY(0);
		pointer-events: auto;
		opacity: 1;
	}
	.toast-msg {
		flex: 1;
	}
	.toast-close {
		background: none;
		border: none;
		color: #fff;
		font-size: 1.1rem;
		cursor: pointer;
		padding: 0 0.2rem;
		opacity: 0.8;
	}
	.toast-close:hover {
		opacity: 1;
	}
</style>

<script>
	function initExportButton(wrapper: HTMLElement) {
		const slug = wrapper.dataset.exportSlug;
		if (!slug) return;

		const btn = wrapper.querySelector<HTMLButtonElement>(".export-btn");
		const labelEl = wrapper.querySelector<HTMLSpanElement>(".export-label");

		if (!btn || !labelEl) return;

		const originalLabel = labelEl.textContent ?? "Download as PDF";

		// Toast helper
		const toast = document.querySelector<HTMLElement>(".export-toast");
		const toastMsg = toast?.querySelector<HTMLElement>(".toast-msg");
		const toastClose =
			toast?.querySelector<HTMLButtonElement>(".toast-close");
		let toastTimer: ReturnType<typeof setTimeout>;

		function showToast(msg: string) {
			if (!toast || !toastMsg) return;
			clearTimeout(toastTimer);
			toastMsg.textContent = msg;
			toast.classList.add("visible");
			toastTimer = setTimeout(
				() => toast.classList.remove("visible"),
				8000,
			);
		}

		toastClose?.addEventListener("click", () => {
			clearTimeout(toastTimer);
			toast?.classList.remove("visible");
		});

		btn.addEventListener("click", async () => {
			if (btn.disabled) return;

			// ── Loading state ──────────────────────────────────────────────
			btn.disabled = true;
			btn.classList.add("is-loading");
			labelEl.textContent = "Printing…";

			try {
				// Include locale date so the cover page shows when this was downloaded
				const d = new Date();
				const day = d.getDate();
				const suffix = [11, 12, 13].includes(day)
					? "th"
					: day % 10 === 1
						? "st"
						: day % 10 === 2
							? "nd"
							: day % 10 === 3
								? "rd"
								: "th";
				const month = d.toLocaleDateString("en-GB", { month: "long" });
				const year = d.getFullYear();
				const date = `${day}<sup>${suffix}</sup> ${month} ${year}`;
				const response = await fetch(
					`/api/export/${slug}?date=${encodeURIComponent(date)}`,
				);

				if (!response.ok) {
					let detail = response.statusText;
					try {
						const body = await response.json();
						detail = body.error ?? detail;
					} catch {}
					throw new Error(detail);
				}

				// ── Stream the PDF blob and trigger download ───────────────
				const blob = await response.blob();
				const objectUrl = URL.createObjectURL(blob);

				// Try to get filename from Content-Disposition header
				const disposition =
					response.headers.get("Content-Disposition") ?? "";
				const nameMatch = /filename="([^"]+)"/.exec(disposition);
				const filename = nameMatch?.[1] ?? `${slug}.pdf`;

				const anchor = document.createElement("a");
				anchor.href = objectUrl;
				anchor.download = filename;
				document.body.appendChild(anchor);
				anchor.click();
				document.body.removeChild(anchor);

				// Clean up after a short delay
				setTimeout(() => URL.revokeObjectURL(objectUrl), 5_000);
			} catch (err) {
				const msg = err instanceof Error ? err.message : String(err);
				showToast(`PDF generation failed: ${msg}`);
			} finally {
				// ── Restore button ─────────────────────────────────────────
				btn.disabled = false;
				btn.classList.remove("is-loading");
				labelEl.textContent = originalLabel;
			}
		});
	}

	// Initialise all export buttons on the page (handles Astro's view transitions)
	function initAll() {
		document
			.querySelectorAll<HTMLElement>("[data-export-slug]")
			.forEach(initExportButton);
	}

	document.addEventListener("DOMContentLoaded", initAll);
	document.addEventListener("astro:page-load", initAll);
</script>
