---
import SaveOutline from "../assets/save-outline.svg?raw";
import SaveSolid from "../assets/save-solid.svg?raw";

// Get initial state from cookie
const saves = Astro.cookies.get("wotb_saves")?.json() || {};
---

<button
	id="saveButton"
	class="inline-flex items-center gap-2 px-4 py-2 text-sm rounded-full transition-all duration-300 hover:bg-gray-100 dark:hover:bg-gray-800"
	aria-label="Save content"
>
	<span id="saveIcon" class="w-5 h-5" set:html={SaveOutline} />
	<span id="saveSolidIcon" class="w-5 h-5 hidden" set:html={SaveSolid} />
	<span>Save</span>
</button>

<script>
	function getCookie(name: string) {
		const value = `; ${document.cookie}`;
		const parts = value.split(`; ${name}=`);
		if (parts.length === 2) return parts.pop()?.split(";").shift();
		return null;
	}

	function setCookie(name: string, value: any, days = 365) {
		const date = new Date();
		date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000);
		document.cookie = `${name}=${JSON.stringify(value)};expires=${date.toUTCString()};path=/`;
	}

	const btn = document.getElementById("saveButton");
	const outline = document.getElementById("saveIcon");
	const solid = document.getElementById("saveSolidIcon");
	const slug = window.location.pathname.replace(/^\/+/, "");

	function getSaves() {
		const data = getCookie("wotb_saves");
		return data ? JSON.parse(data) : {};
	}

	function updateState(isSaveed: boolean) {
		if (isSaveed) {
			btn?.classList.add("text-primary-color", "dark:text-primary-color");
			outline?.classList.add("hidden");
			solid?.classList.remove("hidden");
		} else {
			btn?.classList.remove("text-primary-color", "dark:text-primary-color");
			outline?.classList.remove("hidden");
			solid?.classList.add("hidden");
		}
	}

	if (btn) {
		const saves = getSaves();
		updateState(saves[slug]);

		btn.addEventListener("click", () => {
			const current = getSaves();
			const wasSaveed = Boolean(current[slug]);
			current[slug] = !wasSaveed;
			setCookie("wotb_saves", current);
			updateState(!wasSaveed);

			if (!wasSaveed) {
				btn?.classList.add("animate-pulse");
				setTimeout(() => {
					btn?.classList.remove("animate-pulse");
				}, 1000);
			}
		});
	}
</script>
