---
import allQuotes from "../data/buddha_quotes";

interface Props {
	/**
	 * "simple"  â€“ compact card for home page ("Reflection of the Day")
	 * "full"    â€“ standalone page with date, View discourse & View another buttons
	 * "default" â€“ two-line header card (Buddha Quote / Quote of the Day)
	 */
	variant?: "default" | "simple" | "full";
}

const { variant = "default" } = Astro.props;

// Parse "quote text - SOURCE" format
function splitQuote(raw: string) {
	const parts = raw.split(" - ");
	if (parts.length > 1) {
		const source = parts.pop()!;
		return { text: parts.join(" - "), source };
	}
	return { text: raw, source: "" };
}

function toSlug(source: string) {
	return "/" + source.trim().toLowerCase().replace(/\s+/g, "");
}

// Build a fallback from the first quote (used for SSR / no-JS)
const fallback = splitQuote(allQuotes[0] ?? "");
const fallbackLines = fallback.text.split("\n");
const fallbackSlug = fallback.source ? toSlug(fallback.source) : null;

const isFull = variant === "full";
const isSimple = variant === "simple";

// Unique id suffix so multiple instances don't clash
const uid = isFull ? "full" : isSimple ? "simple" : "default";
---

{
	isFull ? (
		/* â”€â”€ Full-page variant â”€â”€ */
		<div class="flex flex-1 items-center justify-center py-10">
			<section class="mx-auto w-full max-w-2xl rounded-3xl border border-[color:var(--surface-border)] bg-[var(--surface-elevated)] p-8 shadow-xl backdrop-blur-sm transition-colors">
				<header class="mb-6 text-center">
					<p class="text-sm font-semibold uppercase tracking-[0.3em] text-[var(--text-muted)]">
						Buddha Quote
					</p>
					<h1 class="mt-2 text-4xl font-semibold tracking-tight text-[var(--surface-ink)]">
						<span aria-hidden="true" class="mr-2">
							ðŸª·
						</span>
						Quote of the Day
					</h1>
					<p
						id={`dq-date-${uid}`}
						class="mt-3 text-sm text-[var(--text-muted)]"
					/>
				</header>
				<article class="space-y-6 text-center">
					<div
						class="flex flex-col gap-1 text-xl leading-relaxed text-[var(--surface-ink)]"
						id={`dq-text-${uid}`}
					>
						{fallbackLines.map((line) => (
							<span>{line}</span>
						))}
					</div>
					<p
						class="text-base font-medium text-[var(--text-muted)]"
						id={`dq-source-${uid}`}
					>
						{fallback.source}
					</p>
				</article>
				<footer class="mt-8 flex flex-col items-center gap-3 text-sm text-[var(--text-muted)] sm:flex-row sm:justify-center sm:gap-4">
					<a
						id={`dq-link-${uid}`}
						href={fallbackSlug ?? "#"}
						class:list={[
							"inline-flex items-center gap-1 px-4 py-2 text-sm rounded-full border border-[color:var(--surface-border)] transition-all duration-200 shadow-sm focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--primary-color)] no-underline",
							fallbackSlug
								? "bg-[var(--primary-color)] text-white border-transparent hover:opacity-95"
								: "border-[color:var(--surface-border)] bg-transparent text-[var(--surface-ink)] pointer-events-none opacity-50",
						]}
					>
						View discourse
					</a>
					<button
						id={`dq-another-${uid}`}
						type="button"
						class="inline-flex items-center gap-1 px-4 py-2 text-sm rounded-full transition-all duration-300 border border-[color:var(--surface-border)] hover:bg-[rgba(44,44,44,0.08)] dark:hover:bg-[rgba(231,220,196,0.12)] focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-[var(--primary-color)]"
					>
						View another quote
					</button>
				</footer>
			</section>
		</div>
	) : (
		/* â”€â”€ Compact card variants (simple / default) â”€â”€ */
		<section class="max-w-2xl mx-auto px-4 mb-14">
			<div
				class="rounded-2xl border p-6 sm:p-8 text-center"
				style="border-color:var(--surface-border); background:var(--surface-elevated);"
			>
				{isSimple ? (
					<p
						class="text-sm font-medium uppercase tracking-widest mb-4"
						style="color:var(--text-muted);"
					>
						Reflection of the Day
					</p>
				) : (
					<>
						<p
							class="text-sm font-semibold uppercase tracking-[0.3em] mb-1"
							style="color:var(--text-muted);"
						>
							Buddha Quote
						</p>
						<p
							class="text-lg font-semibold tracking-tight mb-4"
							style="color:var(--text-color);"
						>
							Quote of the Day
						</p>
					</>
				)}
				<blockquote
					class="text-lg sm:text-xl leading-relaxed italic"
					style="quotes:none; border:none; margin:0; padding:0;"
				>
					<span id={`dq-text-${uid}`} class="flex flex-col gap-1">
						{fallbackLines.map((line) => (
							<span>{`\u201C${line}\u201D`}</span>
						))}
					</span>
				</blockquote>
				<p class="mt-3 text-sm" style="color:var(--text-muted);">
					â€”{" "}
					<span id={`dq-source-${uid}`}>
						{fallbackSlug ? (
							<a
								href={fallbackSlug}
								style="color:var(--link-color);"
							>
								{fallback.source}
							</a>
						) : (
							fallback.source
						)}
					</span>
					<span class="mx-1.5" style="opacity:0.35;">
						Â·
					</span>
					<button
						id={`dq-another-${uid}`}
						type="button"
						class="text-sm transition-colors duration-200 cursor-pointer"
						style="color:var(--text-muted); opacity:0.7; background:none; border:none; padding:0;"
					>
						Read another
					</button>
				</p>
			</div>
		</section>
	)
}

<script define:vars={{ allQuotes, uid, isFull }}>
	(function () {
		// --- Helpers ---
		function splitQuote(raw) {
			var parts = raw.split(" - ");
			if (parts.length > 1) {
				var source = parts.pop();
				return { text: parts.join(" - "), source: source };
			}
			return { text: raw, source: "" };
		}

		function toSlug(source) {
			return "/" + source.trim().toLowerCase().replace(/\s+/g, "");
		}

		// --- Golden-ratio daily pick ---
		var PHI = 1.618033988749895;
		var totalQuotes = allQuotes.length;

		function getDayNumber() {
			return Math.floor(new Date().getTime() / 86400000);
		}

		function pickIndex(dayNum) {
			var frac = (dayNum * PHI) % 1;
			if (frac < 0) frac += 1;
			return Math.floor(frac * totalQuotes);
		}

		function formatDisplayDate() {
			return new Intl.DateTimeFormat(undefined, {
				weekday: "long",
				month: "long",
				day: "numeric",
				year: "numeric",
			}).format(new Date());
		}

		// --- State ---
		var currentIndex = -1;

		function pickQuote() {
			if (!totalQuotes) return { text: "", source: "" };
			if (currentIndex === -1) {
				currentIndex = pickIndex(getDayNumber());
			} else {
				var next = currentIndex;
				while (totalQuotes > 1 && next === currentIndex) {
					next = Math.floor(Math.random() * totalQuotes);
				}
				currentIndex = next;
			}
			return splitQuote(allQuotes[currentIndex]);
		}

		// --- DOM refs ---
		var textEl = document.getElementById("dq-text-" + uid);
		var sourceEl = document.getElementById("dq-source-" + uid);
		var dateEl = document.getElementById("dq-date-" + uid);
		var linkEl = document.getElementById("dq-link-" + uid);
		var btnEl = document.getElementById("dq-another-" + uid);

		function render() {
			var q = pickQuote();
			if (textEl) {
				textEl.innerHTML = "";
				var lines = q.text.split("\n");
				for (var i = 0; i < lines.length; i++) {
					var span = document.createElement("span");
					if (isFull) {
						span.textContent = lines[i];
					} else {
						span.textContent =
							(i === 0 ? "\u201C" : "") +
							lines[i] +
							(i === lines.length - 1 ? "\u201D" : "");
					}
					textEl.appendChild(span);
				}
			}
			if (sourceEl) {
				if (isFull) {
					sourceEl.textContent = q.source;
				} else if (q.source) {
					var slug = toSlug(q.source);
					sourceEl.innerHTML =
						'<a href="' +
						slug +
						'" style="color:var(--link-color);">' +
						q.source +
						"</a>";
				}
			}
			if (dateEl) {
				dateEl.textContent = formatDisplayDate();
			}
			if (linkEl) {
				if (q.source) {
					linkEl.setAttribute("href", toSlug(q.source));
					linkEl.classList.remove(
						"pointer-events-none",
						"opacity-50",
					);
					linkEl.classList.add(
						"bg-[var(--primary-color)]",
						"text-white",
						"border-transparent",
					);
				} else {
					linkEl.setAttribute("href", "#");
					linkEl.classList.add("pointer-events-none", "opacity-50");
					linkEl.classList.remove(
						"bg-[var(--primary-color)]",
						"text-white",
						"border-transparent",
					);
				}
			}
		}

		// --- Events ---
		if (btnEl) {
			btnEl.addEventListener("click", render);
		}
		if (isFull) {
			document.addEventListener("visibilitychange", function () {
				if (document.visibilityState === "visible") {
					currentIndex = -1;
					render();
				}
			});
		}

		render();
	})();
</script>
